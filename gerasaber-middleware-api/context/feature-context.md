# User Stories — File Processing Middleware

This document defines two core **user stories** for the Java Spring Boot
middleware application responsible for mediating communication between the
user browser, the **n8n automation server**, and the **local file storage** system.

The design follows **Clean Architecture** principles to ensure flexibility,
maintainability, and extensibility — especially in the area of **file storage
abstraction**.

---

## User Story 1 — Upload and Forward Files to n8n

### Story Description
As a **user**,  
I want to **upload multiple files of different types** (e.g., PDF, DOCX, TXT, CSV)
along with a **prompt description field**,  
so that these files and instructions can be **forwarded to the n8n workflow**
which will process them using **ChatGPT**.

### Acceptance Criteria
- Endpoint: `POST /api/upload`
- Input:
  - `multipart/form-data` request containing:
    - One or more **file parts** (`files[]`)
    - A **prompt field** (`promptDescription`) — text describing the processing instructions
- Behavior:
  - Validate input for presence of at least one file and a non-empty prompt description.
  - If validation passes:
    - Return `202 ACCEPTED` to the client.
    - Forward the files and prompt data to the **n8n endpoint** using `WebClient` or `RestTemplate`.
  - If validation fails:
    - Return `404 BAD REQUEST` with error details in JSON format.
- Output:
  - JSON structure:
    ```json
    {
      "data": {
        "message": "Request accepted for processing",
        "timestamp": "2025-10-26T12:00:00Z"
      }
    }
    ```
  - In case of error:
    ```json
    {
      "errors": ["Missing files or invalid prompt description"]
    }
    ```

### Business Logic
- Create a **business object** (service) named `FileUploadService`
  implementing the interface `IFileUploadService`.
- This service will:
  - Validate incoming payloads.
  - Convert them into an **UploadRequest domain object**.
  - Forward the files and metadata to an external n8n endpoint configured in `application.yml`.
  - Handle HTTP headers, Bearer token, and response validation.

### Example Configuration (YAML)
```yaml
n8n:
  base-url: ${N8N_BASE_URL}
  upload-endpoint: /webhook/chatgpt-summarization
  auth-token: ${N8N_AUTH_TOKEN}
```

---

## User Story 2 — Webhook for Receiving Processed PDF

### Story Description
As the **middleware system**,  
I want to **expose a webhook endpoint** capable of receiving a **PDF file**
generated by the n8n/ChatGPT process,  
so that I can **store it safely** in the configured storage system.

### Acceptance Criteria
- Endpoint: `POST /api/webhook/n8n-response`
- Input:
  - JSON payload or multipart containing:
    - The **generated PDF file**.
    - Optional metadata (file name, request ID, timestamp).
- Behavior:
  - Validate the payload integrity.
  - Decode the PDF file (Base64 or binary stream).
  - Save the file into the **configured file storage** implementation.
  - Return `200 OK` with JSON confirmation.
- Output:
  ```json
  {
    "data": {
      "message": "PDF successfully stored",
      "path": "/var/app/files/2025-10-26/summary.pdf"
    }
  }
  ```

---

## File Storage Abstraction Layer

### Design Principle
The application must provide an **abstract storage layer** following
**Clean Architecture** rules to ensure the system remains **independent of
infrastructure details**.

### Architecture Layers

#### Domain Layer
- Define a **StoragePort** interface to abstract all file storage operations:
  ```java
  public interface IFileStoragePort {
      Path saveFile(String filename, byte[] content);
      Optional<Path> findFile(String filename);
  }
  ```

#### Infrastructure Layer
- Implement concrete adapters for different storage backends:
  - `LocalFileStorageAdapter` (default)
  - `S3FileStorageAdapter` (future)
  - `AzureBlobStorageAdapter` (future)
- Each implementation must be annotated with `@Component` and implement
  `IFileStoragePort`.

#### Default Configuration
- If **no storage configuration** is found, the application must automatically
  use the **local system temporary directory**:
  ```java
  Path defaultPath = Paths.get(System.getProperty("java.io.tmpdir"));
  ```
  Example storage behavior:
  ```
  /tmp/middleware/files/summary-20251026-uuid.pdf
  ```

#### Dependency Injection
- The service layer must depend only on the interface `IFileStoragePort`.
- Spring Boot will inject the active storage implementation via `@Primary` or
  configuration-based bean selection.

---

## High-Level Flow Summary

1. **Upload Request Flow**
   - `User → /api/upload`
   - Controller → `FileUploadService` → `n8n HTTP call`
   - Response: `202 Accepted`

2. **Webhook Flow**
   - `n8n → /api/webhook/n8n-response`
   - Controller → `WebhookService` → `IFileStoragePort.saveFile()`
   - Response: `200 OK`

---

## Summary

This design enforces **Clean Architecture**, **SOLID principles**, and
**storage abstraction** via well-defined ports and adapters.  
The system remains extensible to support **new storage providers** (e.g., S3,
Azure, GCP) without requiring any changes to core business logic or controllers.
